<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculateur de Stockage d'Énergie Avancé</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@1.2.1/dist/chartjs-plugin-zoom.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .input-group { display: flex; align-items: center; margin-bottom: 0.75rem; }
        .input-group label { flex: 1; margin-right: 1rem; font-size: 0.875rem; color: #4B5563; }
        .input-group .input-container { flex: 1; display: flex; align-items: center; }
        .input-group input, .input-group select { width: 100%; padding: 0.5rem; border-radius: 0.375rem; border: 1px solid #D1D5DB; }
        .input-group input { text-align: right; }
        .input-group .unit { margin-left: 0.5rem; font-size: 0.875rem; color: #6B7280; min-width: 60px; }
        .calc-step { margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid #E5E7EB; }
        .calc-step:last-child { border-bottom: none; padding-bottom: 0; }
        .calc-title { font-size: 1.125rem; font-weight: 600; color: #1F2937; margin-bottom: 0.5rem; }
        .calc-formula { font-family: monospace; background-color: #F3F4F6; padding: 0.75rem; border-radius: 0.375rem; color: #374151; font-size: 0.8rem; white-space: pre-wrap; word-wrap: break-word; line-height: 1.5; }
        .calc-value { font-weight: 700; color: #4F46E5; }
        details > summary { cursor: pointer; }
        .file-input-label { display: block; padding: 0.75rem 1rem; border: 2px dashed #D1D5DB; border-radius: 0.5rem; text-align: center; cursor: pointer; background-color: #F9FAFB; color: #4B5563; transition: background-color 0.2s, border-color 0.2s; }
        .file-input-label:hover { background-color: #F3F4F6; border-color: #9CA3AF; }
        #profile_uploader { display: none; }
        .tab-button { padding: 0.5rem 1rem; cursor: pointer; border-bottom: 2px solid transparent; font-size: 0.875rem; }
        .tab-button.active { border-color: #4F46E5; color: #4F46E5; font-weight: 600; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>

<body class="bg-gray-50 text-gray-800">
    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Calculateur de Stockage d'Énergie</h1>
            <p class="text-md text-gray-600 mt-2">Simulation Annuelle, Analyse Financière et Optimisation</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Colonne 1: Entrées -->
            <div class="lg:col-span-1 bg-white p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-bold mb-6 border-b pb-4">Paramètres</h2>
                <details class="mb-4" open>
                    <summary class="text-lg font-semibold">Simulation & Technologie</summary>
                    <div class="mt-4 pl-4 border-l-2 border-gray-200">
                        <div class="mb-6">
                            <h3 class="text-md font-semibold mb-3">Profil de Simulation (CSV)</h3>
                            <label for="profile_uploader" class="file-input-label"><span>Choisir un profil CSV (8760h)</span></label>
                            <input type="file" id="profile_uploader" accept=".csv">
                            <p id="file-name" class="text-sm mt-2"></p>
                            <p class="text-xs text-gray-500 mt-1">Colonnes requises : `production_wh_per_kwp`, `consumption_wh`.</p>
                        </div>
                        <div class="mb-6">
                            <h3 class="text-md font-semibold mb-3">Installation PV</h3>
                            <div class="input-group"><label for="pv_peak_power">Puissance Crête PV</label><div class="input-container"><input type="number" id="pv_peak_power" value="5"><span class="unit">kWp</span></div></div>
                        </div>
                        <div class="mb-6">
                            <h3 class="text-md font-semibold mb-3">Technologie de Stockage</h3>
                            <select id="technology_selector" class="w-full bg-gray-100 border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                <option value="lithium_ion">Batterie Lithium-ion</option>
                                <option value="vanadium_flow">Batterie à flux Vanadium</option>
                                <option value="pumped_hydro">Pompage-turbinage</option>
                            </select>
                        </div>
                    </div>
                </details>
                <details class="mb-4">
                    <summary class="text-lg font-semibold">Paramètres de la Batterie</summary>
                    <div class="mt-4 pl-4 border-l-2 border-gray-200">
                        <div class="input-group"><label for="power_capacity">Puissance nominale</label><div class="input-container"><input type="number" id="power_capacity" value="5"><span class="unit">kW</span></div></div>
                        <div class="input-group"><label for="discharge_duration">Durée de décharge</label><div class="input-container"><input type="number" id="discharge_duration" value="2"><span class="unit">heures</span></div></div>
                        <div class="input-group"><label for="investment_power">Coût d'inv. - Puissance</label><div class="input-container"><input type="number" id="investment_power"><span class="unit">$/kW</span></div></div>
                        <div class="input-group"><label for="investment_energy">Coût d'inv. - Énergie</label><div class="input-container"><input type="number" id="investment_energy"><span class="unit">$/kWh</span></div></div>
                        <div class="input-group"><label for="round_trip_efficiency">Rendement A/R (RTE)</label><div class="input-container"><input type="number" id="round_trip_efficiency"><span class="unit">%</span></div></div>
                        <div class="input-group"><label for="depth_of_discharge">Profondeur de Décharge (DoD)</label><div class="input-container"><input type="number" id="depth_of_discharge"><span class="unit">%</span></div></div>
                        <div class="input-group"><label for="cycle_lifetime">Durée de vie (cycles)</label><div class="input-container"><input type="number" id="cycle_lifetime"><span class="unit">cycles</span></div></div>
                        <div class="input-group"><label for="temporal_degradation">Dégradation temporelle</label><div class="input-container"><input type="number" id="temporal_degradation" step="0.01"><span class="unit">% / an</span></div></div>
                        <div class="input-group"><label for="eol_threshold">Seuil fin de vie (SOH)</label><div class="input-container"><input type="number" id="eol_threshold"><span class="unit">%</span></div></div>
                    </div>
                </details>
                <details class="mb-4">
                    <summary class="text-lg font-semibold">Scénario Économique</summary>
                    <div class="mt-4 pl-4 border-l-2 border-gray-200">
                        <div class="input-group"><label for="charging_cost">Prix Achat Électricité</label><div class="input-container"><input type="number" id="charging_cost" value="0.20" step="0.01"><span class="unit">$/kWh</span></div></div>
                        <div class="input-group"><label for="selling_price">Prix Vente Surplus</label><div class="input-container"><input type="number" id="selling_price" value="0.10" step="0.01"><span class="unit">$/kWh</span></div></div>
                        <div class="input-group"><label for="om_power">O&M - Puissance</label><div class="input-container"><input type="number" id="om_power"><span class="unit">$/kW-an</span></div></div>
                        <div class="input-group"><label for="eol_cost_energy">Coût fin de vie (valeur)</label><div class="input-container"><input type="number" id="eol_cost_energy"><span class="unit">$/kWh</span></div></div>
                        <div class="input-group"><label for="discount_rate">Taux d'actualisation</label><div class="input-container"><input type="number" id="discount_rate" value="5"><span class="unit">%</span></div></div>
                    </div>
                </details>
                <div class="mt-8">
                    <button id="calculate_button" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors duration-300">
                        Lancer la Simulation
                    </button>
                </div>
            </div>

            <!-- Colonne 2 & 3: Résultats -->
            <div id="results_columns" class="lg:col-span-2 bg-white p-6 rounded-lg shadow-lg hidden">
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-4 flex-wrap" aria-label="Tabs">
                        <button class="tab-button active" data-tab="summary_tab">Bilan & Coûts</button>
                        <button class="tab-button" data-tab="profile_tab">Profils Détaillés</button>
                        <button class="tab-button" data-tab="flow_tab">Flux Énergétiques</button>
                        <button class="tab-button" data-tab="details_tab">Détails Calculs</button>
                        <button class="tab-button" data-tab="optim_tab">Optimisation</button>
                    </nav>
                </div>

                <div id="summary_tab" class="tab-content active mt-6">
                    <div id="results_content"></div>
                </div>

                <div id="profile_tab" class="tab-content mt-6">
                    <div class="mt-8 pt-6 border-t">
                         <h3 class="text-xl font-semibold mb-4">Aperçu Hebdomadaire Détaillé</h3>
                         <div class="flex items-center space-x-4 mb-6 bg-gray-100 p-3 rounded-md">
                            <label for="week_selector" class="font-semibold text-sm">Choisir une semaine :</label>
                            <input type="week" id="week_selector" class="border-gray-300 rounded-md shadow-sm text-sm">
                         </div>
                         <div style="height: 450px;">
                            <canvas id="weekly_overview_chart"></canvas>
                         </div>
                    </div>
                </div>

                <div id="flow_tab" class="tab-content mt-6">
                    <h3 class="text-xl font-semibold mb-4">Bilan des Flux Énergétiques Annuels</h3>
                    <canvas id="energy_flow_chart"></canvas>
                </div>
                
                <div id="details_tab" class="tab-content mt-6">
                    <h3 class="text-xl font-semibold mb-4">Détails des Calculs</h3>
                    <div id="calculation_details"></div>
                    <div class="mt-8 pt-6 border-t">
                        <h3 class="text-xl font-semibold mb-4">Analyse Comparative des Technologies</h3>
                        <p class="text-sm text-gray-600 mb-4">Comparez le LCOS et le retour sur investissement pour différentes technologies.</p>
                        <button id="compare_button" class="w-full mb-4 bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700">Lancer la Comparaison</button>
                        <div id="comparative_results_container" class="hidden">
                            <canvas id="comparative_chart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div id="optim_tab" class="tab-content mt-6">
                    <div id="optimization_section">
                        <h3 class="text-xl font-semibold mb-4">Optimisation de la Taille de la Batterie</h3>
                        <div class="input-group"><label for="optim_min_cap">Capacité Énerg. Min</label><div class="input-container"><input type="number" id="optim_min_cap" value="2"><span class="unit">kWh</span></div></div>
                        <div class="input-group"><label for="optim_max_cap">Capacité Énerg. Max</label><div class="input-container"><input type="number" id="optim_max_cap" value="20"><span class="unit">kWh</span></div></div>
                        <div class="input-group"><label for="optim_step">Pas</label><div class="input-container"><input type="number" id="optim_step" value="1"><span class="unit">kWh</span></div></div>
                        <button id="optimize_button" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Lancer l'Optimisation</button>
                        <div id="optimization_results_container" class="mt-4 hidden">
                             <canvas id="optimization_chart"></canvas>
                             <p id="optimization_summary" class="text-center font-semibold mt-2"></p>
                        </div>
                    </div>
                </div>

                <div id="download_container" class="mt-8 hidden">
                    <button id="download_button" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700">
                        Télécharger le Rapport (Excel)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- DATA & CONFIG ---
            const techData = { 'lithium_ion': { name: "Lithium Ion", investment_power: 250, investment_energy: 300, om_power: 5, eol_cost_energy: 0, round_trip_efficiency: 86, depth_of_discharge: 80, cycle_lifetime: 3500, temporal_degradation: 1, eol_threshold: 80, om_energy: 0.4, self_discharge: 1 }, 'vanadium_flow': { name: "Vanadium Flow", investment_power: 700, investment_energy: 450, om_power: 10, eol_cost_energy: -100, round_trip_efficiency: 68, depth_of_discharge: 100, cycle_lifetime: 20000, temporal_degradation: 0.1, eol_threshold: 80, om_energy: 2, self_discharge: 0 }, 'pumped_hydro': { name: "Pompage-turbinage", investment_power: 1100, investment_energy: 50, om_power: 20, eol_cost_energy: 0, round_trip_efficiency: 80, depth_of_discharge: 100, cycle_lifetime: 30000, temporal_degradation: 0, eol_threshold: 95, om_energy: 0.4, self_discharge: 0 } };
            let profileData = [];
            let lastResults = null;
            let charts = {};

            // --- DOM ELEMENTS ---
            const techSelector = document.getElementById('technology_selector');
            const calculateButton = document.getElementById('calculate_button');
            const downloadButton = document.getElementById('download_button');
            const profileUploader = document.getElementById('profile_uploader');
            const fileNameDisplay = document.getElementById('file-name');
            const optimizeButton = document.getElementById('optimize_button');
            const compareButton = document.getElementById('compare_button');
            const weekSelector = document.getElementById('week_selector');

            // --- UTILITY FUNCTIONS ---
            const formatNumber = (value, decimals = 2) => (isNaN(value) || !isFinite(value)) ? "N/A" : value.toLocaleString('fr-FR', { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
            const formatCurrency = (value, unit = '$') => (isNaN(value) || !isFinite(value)) ? `N/A ${unit.trim()}` : `${value < 0 ? '-' : ''}${unit.trim()}${formatNumber(Math.abs(value))}`;
            
            function showModal(message) {
                const existingModal = document.getElementById('custom-modal');
                if (existingModal) existingModal.remove();
                const messageBox = document.createElement('div');
                messageBox.id = 'custom-modal';
                messageBox.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50';
                messageBox.innerHTML = `<div class="bg-white p-6 rounded-lg shadow-xl text-center max-w-sm"><p class="text-lg font-semibold mb-4">${message}</p><button class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">OK</button></div>`;
                messageBox.querySelector('button').onclick = () => messageBox.remove();
                document.body.appendChild(messageBox);
            }

            // --- DATA HANDLING & PARSING ---
            function getInputs() {
                const inputs = {};
                document.querySelectorAll('input, select').forEach(el => { if (el.id) inputs[el.id] = el.type === 'number' ? parseFloat(el.value) || 0 : el.value; });
                const selectedTech = techData[inputs.technology_selector];
                inputs.om_energy = selectedTech.om_energy;
                inputs.self_discharge = selectedTech.self_discharge;
                return inputs;
            }

            function handleProfileFile(event) {
                const file = event.target.files[0];
                if (!file) return;
                fileNameDisplay.textContent = `Lecture de ${file.name}...`;
                fileNameDisplay.classList.remove('text-red-500', 'text-green-600');
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const lines = e.target.result.trim().split(/\r?\n/);
                        if (lines.length < 8760) throw new Error("Le fichier CSV doit contenir au moins 8760 lignes de données.");
                        const headerLine = lines[0].toLowerCase();
                        const delimiter = headerLine.includes(';') ? ';' : ',';
                        const headers = headerLine.split(delimiter).map(h => h.trim().replace(/"/g, ''));
                        const prodIndex = headers.indexOf('production_wh_per_kwp');
                        const consIndex = headers.indexOf('consumption_wh');
                        if (prodIndex === -1 || consIndex === -1) throw new Error("En-têtes requis introuvables.");
                        profileData = lines.slice(1).map(row => {
                            const values = row.split(delimiter);
                            const prodVal = parseFloat(values[prodIndex]);
                            const consVal = parseFloat(values[consIndex]);
                            return (isFinite(prodVal) && isFinite(consVal)) ? { production_wh_per_kwp: prodVal, consumption_wh: consVal } : null;
                        }).filter(Boolean);
                        if (profileData.length >= 8760) {
                            fileNameDisplay.textContent = `${profileData.length} heures de données chargées.`;
                            fileNameDisplay.classList.add('text-green-600');
                            weekSelector.value = '2025-W01';
                            weekSelector.disabled = false;
                        } else {
                            throw new Error(`Données insuffisantes: ${profileData.length} lignes lues.`);
                        }
                    } catch (error) {
                        fileNameDisplay.textContent = `Erreur: ${error.message}`;
                        fileNameDisplay.classList.add('text-red-500');
                        profileData = [];
                        weekSelector.disabled = true;
                    }
                };
                reader.readAsText(file);
            }

            // --- CORE SIMULATION & CALCULATION ---
            function runProfileSimulation(inputs, profile) {
                const batteryCapacity_kWh = inputs.power_capacity * inputs.discharge_duration;
                const usableCapacity_kWh = batteryCapacity_kWh * (inputs.depth_of_discharge / 100);
                const minSoc_kWh = batteryCapacity_kWh * (1 - (inputs.depth_of_discharge / 100));
                const maxSoc_kWh = minSoc_kWh + usableCapacity_kWh;
                const chargePowerLimit_kW = inputs.power_capacity;
                const dischargePowerLimit_kW = inputs.power_capacity;
                const rte_decimal = inputs.round_trip_efficiency / 100;
                const self_discharge_hourly_decimal = inputs.self_discharge / 100 / 24; 
                const charge_eff_hourly = Math.sqrt(rte_decimal);
                const discharge_eff_hourly = Math.sqrt(rte_decimal);
                let soc_kWh = minSoc_kWh + usableCapacity_kWh / 2;
                let hourly = { soc: [], prod: [], cons: [], batteryCharge: [], batteryDischarge: [], gridImport: [], gridExport: [], hourlyNetCost: [] };
                let totals = { import: 0, export: 0, charge: 0, discharge: 0, consumption: 0, production: 0, direct: 0 };
                for (let i = 0; i < profile.length; i++) {
                    const production_kWh = (profile[i].production_wh_per_kwp * inputs.pv_peak_power) / 1000;
                    const consumption_kWh = profile[i].consumption_wh / 1000;
                    soc_kWh = Math.max(minSoc_kWh, soc_kWh * (1 - self_discharge_hourly_decimal));
                    totals.production += production_kWh;
                    totals.consumption += consumption_kWh;
                    let netEnergy = production_kWh - consumption_kWh;
                    let currentBatteryCharge_kWh = 0, currentBatteryDischarge_kWh = 0, currentGridImport_kWh = 0, currentGridExport_kWh = 0;
                    if (netEnergy > 0) {
                        const availableForCharge = Math.min(netEnergy, chargePowerLimit_kW);
                        const maxChargeIntoBattery = (maxSoc_kWh - soc_kWh) / charge_eff_hourly; 
                        const actualChargeAmount_kWh = Math.min(availableForCharge, maxChargeIntoBattery);
                        soc_kWh += actualChargeAmount_kWh * charge_eff_hourly;
                        currentBatteryCharge_kWh = actualChargeAmount_kWh;
                        currentGridExport_kWh = netEnergy - actualChargeAmount_kWh;
                    } else if (netEnergy < 0) {
                        const neededFromBattery = Math.min(Math.abs(netEnergy), dischargePowerLimit_kW);
                        const maxDischargeFromBattery = (soc_kWh - minSoc_kWh) * discharge_eff_hourly;
                        const actualDischargeAmount_kWh = Math.min(neededFromBattery, maxDischargeFromBattery);
                        soc_kWh -= actualDischargeAmount_kWh / discharge_eff_hourly;
                        currentBatteryDischarge_kWh = actualDischargeAmount_kWh;
                        currentGridImport_kWh = Math.abs(netEnergy) - actualDischargeAmount_kWh;
                    }
                    totals.charge += currentBatteryCharge_kWh;
                    totals.discharge += currentBatteryDischarge_kWh;
                    totals.import += currentGridImport_kWh;
                    totals.export += currentGridExport_kWh;
                    totals.direct += Math.min(production_kWh, consumption_kWh);
                    hourly.soc.push(batteryCapacity_kWh > 0 ? (soc_kWh / batteryCapacity_kWh) * 100 : 0);
                    hourly.prod.push(production_kWh * 1000);
                    hourly.cons.push(consumption_kWh * 1000);
                    hourly.batteryCharge.push(currentBatteryCharge_kWh * 1000);
                    hourly.batteryDischarge.push(currentBatteryDischarge_kWh * 1000);
                    hourly.gridImport.push(currentGridImport_kWh * 1000);
                    hourly.gridExport.push(currentGridExport_kWh * 1000);
                    hourly.hourlyNetCost.push((currentGridImport_kWh * inputs.charging_cost) - (currentGridExport_kWh * inputs.selling_price));
                }
                const equivalentCycles = usableCapacity_kWh > 0 ? totals.discharge / usableCapacity_kWh : 0;
                return { equivalentCycles, totals, hourly };
            }

            function runFinancialCalculation(inputs, simResults) {
                const P_cap_kW = inputs.power_capacity;
                const E_cap_kWh = inputs.power_capacity * inputs.discharge_duration;
                const r = inputs.discount_rate / 100;
                const deg_t = inputs.temporal_degradation / 100;
                const eol_thresh = inputs.eol_threshold / 100;
                const annual_cycles = simResults.equivalentCycles;
                const Life_cyc = inputs.cycle_lifetime;
                const deg_c = Life_cyc > 0 ? (1 - Math.pow(eol_thresh, 1 / Life_cyc)) : 0;
                let N_op = 50;
                const log_term_denominator = Math.log(1 - deg_t) + annual_cycles * Math.log(1 - deg_c);
                if (log_term_denominator < 0 && eol_thresh > 0) { N_op = Math.log(eol_thresh) / log_term_denominator; }
                N_op = Math.min(50, Math.max(0, isFinite(N_op) ? N_op : 50));
                const initial_investment = (inputs.investment_power * P_cap_kW) + (inputs.investment_energy * E_cap_kWh);
                let total_discounted_cost = initial_investment, total_discounted_energy_out = 0;
                const cost_components = { investment: initial_investment, om: 0, eol: 0, charging: 0 };
                for (let n = 1; n <= N_op; n++) {
                    const discount_factor = 1 / Math.pow(1 + r, n);
                    const SOH_at_year_n = Math.pow(1 - deg_t, n) * Math.pow(1 - deg_c, n * annual_cycles);
                    const Eout_n = simResults.totals.discharge * SOH_at_year_n;
                    total_discounted_energy_out += Eout_n * discount_factor;
                    const Ein_n = simResults.totals.charge * SOH_at_year_n;
                    cost_components.om += ((inputs.om_power * P_cap_kW) + (inputs.om_energy * Eout_n / 1000)) * discount_factor;
                    cost_components.charging += (Ein_n * inputs.selling_price) * discount_factor;
                }
                const final_soh_factor_at_N_op = Math.pow(1 - deg_t, N_op) * Math.pow(1 - deg_c, N_op * annual_cycles);
                cost_components.eol = (inputs.eol_cost_energy * E_cap_kWh * final_soh_factor_at_N_op) / Math.pow(1 + r, N_op);
                total_discounted_cost += cost_components.om + cost_components.charging - cost_components.eol;
                const lcos = total_discounted_energy_out > 0 ? total_discounted_cost / total_discounted_energy_out : 0;
                const annuity_factor = (r > 0) ? (r * Math.pow(1 + r, N_op)) / (Math.pow(1 + r, N_op) - 1) : (N_op > 0 ? 1/N_op : 0);
                const annualized_cost = total_discounted_cost * annuity_factor;
                const acc = P_cap_kW > 0 ? annualized_cost / P_cap_kW : 0;
                const annual_net_economic_balance = ((simResults.totals.direct + simResults.totals.discharge) * inputs.charging_cost) + (simResults.totals.export * inputs.selling_price) - (simResults.totals.import * inputs.charging_cost);
                const simple_payback = annual_net_economic_balance > 0 ? initial_investment / annual_net_economic_balance : Infinity;
                return { N_op, lcos, acc, simple_payback, initial_investment, annual_cycles, E_cap_kWh, P_cap_kW, total_discounted_cost, total_discounted_energy_out, cost_components };
            }

            // --- UI & DISPLAY FUNCTIONS ---
            function calculateAndShowResults() {
                if (profileData.length === 0) { showModal("Veuillez d'abord charger un fichier de profil CSV."); return; }
                document.getElementById('results_columns').classList.remove('hidden');
                
                const currentInputs = getInputs();
                const simResults = runProfileSimulation(currentInputs, profileData);
                const mainResults = runFinancialCalculation(currentInputs, simResults);
                
                lastResults = { inputs: currentInputs, simResults, financialResults: mainResults };
                
                displayMainResults(simResults, mainResults);
                displayCalculationDetails(currentInputs, mainResults);
                updateAndDisplayWeeklyChart();
                displayEnergyFlowChart(simResults);
                document.getElementById('comparative_results_container').classList.add('hidden');
                document.getElementById('optimization_results_container').classList.add('hidden');
                document.getElementById('download_container').classList.remove('hidden');
            }
            
            function displayMainResults(sim, fin) {
                const selfConsumptionRate = sim.totals.production > 0 ? (sim.totals.direct + sim.totals.discharge) / sim.totals.production * 100 : 0;
                const selfSufficiencyRate = sim.totals.consumption > 0 ? (sim.totals.direct + sim.totals.discharge) / sim.totals.consumption * 100 : 0;
                document.getElementById('results_content').innerHTML = `
                    <div class="mb-4"><h3 class="text-xl font-semibold mb-2">Bilan Énergétique Annuel</h3>
                        <div class="space-y-2 text-sm"><div class="flex justify-between"><span>Production PV:</span> <strong>${formatNumber(sim.totals.production, 0)} kWh</strong></div><div class="flex justify-between"><span>Consommation:</span> <strong>${formatNumber(sim.totals.consumption, 0)} kWh</strong></div><div class="flex justify-between"><span>Import Réseau:</span> <strong>${formatNumber(sim.totals.import, 0)} kWh</strong></div><div class="flex justify-between"><span>Export Réseau:</span> <strong>${formatNumber(sim.totals.export, 0)} kWh</strong></div></div>
                    </div>
                     <div class="mb-4"><h3 class="text-xl font-semibold mb-2">Performance du Système</h3>
                        <div class="grid grid-cols-2 gap-4"><div><p class="text-2xl font-bold text-green-600">${formatNumber(selfConsumptionRate, 1)}%</p><p class="text-sm text-gray-500">Taux d'autoconsommation</p></div><div><p class="text-2xl font-bold text-green-600">${formatNumber(selfSufficiencyRate, 1)}%</p><p class="text-sm text-gray-500">Taux d'autosuffisance</p></div></div>
                    </div>
                    <div class="mb-4"><h3 class="text-xl font-semibold mb-2">Analyse Financière</h3>
                        <div class="grid grid-cols-2 gap-4"><div><p class="text-2xl font-bold text-indigo-600">${formatCurrency(fin.lcos, ' $/kWh')}</p><p class="text-sm text-gray-500">LCOS</p></div><div><p class="text-2xl font-bold text-green-600">${isFinite(fin.simple_payback) ? formatNumber(fin.simple_payback, 1) + ' ans' : 'N/A'}</p><p class="text-sm text-gray-500">Retour sur Investissement</p></div><div><p class="text-2xl font-bold text-gray-800">${formatNumber(fin.N_op, 1)} ans</p><p class="text-sm text-gray-500">Durée de vie</p></div><div><p class="text-2xl font-bold text-gray-800">${formatNumber(fin.annual_cycles, 0)} cycles/an</p><p class="text-sm text-gray-500">Cycles équivalents</p></div></div>
                    </div>`;
            }

            function updateAndDisplayWeeklyChart() {
                if (!lastResults) return;
                const weekValue = weekSelector.value; 
                if (!weekValue) return;

                const weekNumber = parseInt(weekValue.split('-W')[1], 10);
                const startHour = (weekNumber - 1) * 168;
                if (startHour + 168 > lastResults.simResults.hourly.soc.length) return;

                const chartData = {};
                for (const key in lastResults.simResults.hourly) {
                    chartData[key] = lastResults.simResults.hourly[key].slice(startHour, startHour + 168);
                }
                displayWeeklyOverviewChart(chartData, startHour);
            }

            function displayWeeklyOverviewChart(weeklyData, startHourOffset) {
                if (!weeklyData) return;

                const labels = [];
                const startDate = new Date('2025-01-01T00:00:00');
                for (let i = 0; i < 168; i++) {
                    labels.push(new Date(startDate.getTime() + (startHourOffset + i) * 3600 * 1000));
                }
                
                const batteryFlow = weeklyData.batteryDischarge.map((d, i) => d - weeklyData.batteryCharge[i]);

                if (charts.weeklyOverview) charts.weeklyOverview.destroy();
                charts.weeklyOverview = new Chart(document.getElementById('weekly_overview_chart').getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            { label: 'Consommation (Wh)', data: weeklyData.cons, type: 'line', borderColor: 'black', borderWidth: 2, pointRadius: 0, order: 0 },
                            { label: 'Production PV (Wh)', data: weeklyData.prod, type: 'line', borderColor: '#facc15', borderWidth: 2, pointRadius: 0, order: 1 },
                            { label: 'Flux Batterie (Wh)', data: batteryFlow, backgroundColor: batteryFlow.map(v => v >= 0 ? 'rgba(54, 162, 235, 0.7)' : 'rgba(239, 68, 68, 0.7)'), order: 3 },
                            { label: 'SOC (%)', data: weeklyData.soc, type: 'line', borderColor: '#8b5cf6', yAxisID: 'y1', pointRadius: 0, borderWidth: 2, order: 2 }
                        ]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false, interaction: { intersect: false, mode: 'index' },
                        scales: {
                            x: { type: 'time', time: { unit: 'day' }, title: { display: true, text: 'Jour de la semaine' } },
                            y: { title: { display: true, text: 'Puissance (Wh)' } },
                            y1: { type: 'linear', position: 'right', min: 0, max: 100, title: { display: true, text: 'SOC (%)' }, grid: { drawOnChartArea: false } }
                        }
                    }
                });
            }
            
            // --- Other Functions ---
            function displayEnergyFlowChart(sim) { const ctx = document.getElementById('energy_flow_chart').getContext('2d'); const losses = sim.totals.charge - sim.totals.discharge; if(charts.flow) charts.flow.destroy(); charts.flow = new Chart(ctx, { type: 'bar', data: { labels: ['Production PV', 'Consommation Totale', 'Import Réseau', 'Export Réseau', 'Charge Batterie', 'Décharge Batterie', 'Pertes Batterie'], datasets: [{ label: 'Énergie Annuelle (kWh)', data: [sim.totals.production, sim.totals.consumption, sim.totals.import, sim.totals.export, sim.totals.charge, sim.totals.discharge, losses], backgroundColor: ['rgba(52, 211, 153, 0.7)', 'rgba(249, 115, 22, 0.7)', 'rgba(255, 159, 64, 0.7)', 'rgba(75, 192, 192, 0.7)', 'rgba(59, 130, 246, 0.7)', 'rgba(239, 68, 68, 0.7)', 'rgba(156, 163, 175, 0.7)'], }] }, options: { responsive: true, plugins: { legend: { display: false }, title: { display: true, text: 'Bilan des Flux Énergétiques Annuels (kWh)' } }, scales: { y: { beginAtZero: true, title: { display: true, text: 'Énergie (kWh)' } } } } }); }
            function displayCalculationDetails(inputs, r) { document.getElementById('calculation_details').innerHTML = `<div class="calc-step"><h3 class="calc-title">1. Investissement Initial (CAPEX)</h3><p class="calc-formula">(${formatCurrency(inputs.investment_power, '$/kW')} * ${formatNumber(r.P_cap_kW, 2)} kW) + (${formatCurrency(inputs.investment_energy, '$/kWh')} * ${formatNumber(r.E_cap_kWh, 2)} kWh) = <span class="calc-value">${formatCurrency(r.initial_investment, '$')}</span></p></div><div class="calc-step"><h3 class="calc-title">2. Coût Actualisé Total</h3><p class="calc-formula">CAPEX + Σ(O&M) + Σ(Charge) - Fin de Vie = <span class="calc-value">${formatCurrency(r.total_discounted_cost, '$')}</span></p></div><div class="calc-step"><h3 class="calc-title">3. Énergie Totale Fournie (Actualisée)</h3><p class="calc-formula">Σ(Décharge annuelle actualisée) = <span class="calc-value">${formatNumber(r.total_discounted_energy_out, 0)} kWh</span></p></div><div class="calc-step"><h3 class="calc-title">4. LCOS</h3><p class="calc-formula">Coût Actualisé Total / Énergie Fournie Totale = <span class="calc-value">${formatCurrency(r.lcos, '$/kWh')}</span></p></div><div class="calc-step"><h3 class="calc-title">5. Durée de Vie Opérationnelle (N_op)</h3><p class="calc-formula">Calculée à ${formatNumber(r.annual_cycles,0)} cycles/an : <span class="calc-value">${formatNumber(r.N_op, 1)} ans</span></p></div>`; }
            function populateTechInputs(techKey) { const data = techData[techKey]; if (data) { Object.keys(data).forEach(key => { const el = document.getElementById(key.replace(/_([a-z])/g, g => g[1].toUpperCase())); if (el) el.value = data[key]; }); document.getElementById('investment_power').value = data.investment_power; document.getElementById('investment_energy').value = data.investment_energy; document.getElementById('round_trip_efficiency').value = data.round_trip_efficiency; document.getElementById('depth_of_discharge').value = data.depth_of_discharge; document.getElementById('cycle_lifetime').value = data.cycle_lifetime; document.getElementById('temporal_degradation').value = data.temporal_degradation; document.getElementById('eol_threshold').value = data.eol_threshold; document.getElementById('om_power').value = data.om_power; document.getElementById('eol_cost_energy').value = data.eol_cost_energy; }}
            function runComparativeAnalysis() { if (profileData.length === 0) { showModal("Veuillez charger un profil CSV."); return; } const currentInputs = getInputs(); const labels = [], lcosValues = [], paybackValues = []; for (const techKey in techData) { const tempInputs = { ...currentInputs, ...techData[techKey], discharge_duration: currentInputs.discharge_duration }; const simResults = runProfileSimulation(tempInputs, profileData); const financialResults = runFinancialCalculation(tempInputs, simResults); labels.push(techData[techKey].name); lcosValues.push(financialResults.lcos); paybackValues.push(isFinite(financialResults.simple_payback) ? financialResults.simple_payback : null); } document.getElementById('comparative_results_container').classList.remove('hidden'); if(charts.comparative) charts.comparative.destroy(); charts.comparative = new Chart(document.getElementById('comparative_chart').getContext('2d'), { type: 'bar', data: { labels, datasets: [ { label: 'LCOS ($/kWh)', data: lcosValues, backgroundColor: 'rgba(79, 70, 229, 0.7)' }, { label: 'Retour sur Investissement (années)', data: paybackValues, backgroundColor: 'rgba(52, 211, 153, 0.7)' } ]}, options: { responsive: true, plugins: { title: { display: true, text: 'Comparaison LCOS et Retour sur Investissement' } }, scales: { y: { beginAtZero: true, title: { display: true, text: 'Valeur' } } } } }); }
            function runOptimization() { if (profileData.length === 0) { showModal("Veuillez charger un profil CSV."); return; } const minCap = parseFloat(document.getElementById('optim_min_cap').value); const maxCap = parseFloat(document.getElementById('optim_max_cap').value); const step = parseFloat(document.getElementById('optim_step').value); if (isNaN(minCap) || isNaN(maxCap) || isNaN(step) || minCap <= 0 || step <= 0 || minCap > maxCap) { showModal("Valeurs d'optimisation invalides."); return; } const currentInputs = getInputs(); const capacities = [], lcosValues = [], paybackValues = []; let bestLCOS = Infinity, bestCapacity = 0; for (let cap = minCap; cap <= maxCap; cap += step) { const tempInputs = { ...currentInputs, power_capacity: cap / currentInputs.discharge_duration }; const simResults = runProfileSimulation(tempInputs, profileData); const financialResults = runFinancialCalculation(tempInputs, simResults); capacities.push(cap); lcosValues.push(financialResults.lcos); paybackValues.push(isFinite(financialResults.simple_payback) ? financialResults.simple_payback : null); if (financialResults.lcos < bestLCOS && financialResults.lcos > 0) { bestLCOS = financialResults.lcos; bestCapacity = cap; } } document.getElementById('optimization_results_container').classList.remove('hidden'); document.getElementById('optimization_summary').textContent = `Optimum LCOS : ${formatNumber(bestCapacity, 1)} kWh avec ${formatCurrency(bestLCOS, ' $/kWh')}.`; if(charts.optimization) charts.optimization.destroy(); charts.optimization = new Chart(document.getElementById('optimization_chart').getContext('2d'), { type: 'line', data: { labels: capacities.map(c => `${c} kWh`), datasets: [ { label: 'LCOS ($/kWh)', data: lcosValues, borderColor: 'rgb(79, 70, 229)', yAxisID: 'y' }, { label: 'Retour sur Investissement (années)', data: paybackValues, borderColor: 'rgb(52, 211, 153)', yAxisID: 'y1' } ]}, options: { responsive: true, plugins: { title: { display: true, text: 'Optimisation de la Taille de la Batterie' } }, scales: { x: { title: { display: true, text: 'Capacité Énergétique (kWh)' } }, y: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'LCOS ($/kWh)' } }, y1: { type: 'linear', display: true, position: 'right', title: { display: true, text: 'Retour sur Investissement (années)' }, grid: { drawOnChartArea: false } } } } }); }
            function downloadReport() { if (!lastResults) { showModal("Veuillez lancer une simulation avant de télécharger."); return; } const { inputs, simResults, financialResults } = lastResults; const summary_ws_data = [ ["Rapport de Simulation"], [], ["Paramètres"], ["Technologie", techData[inputs.technology_selector].name], ["Puissance Crête PV (kWp)", inputs.pv_peak_power], ["Puissance Nominale Batterie (kW)", inputs.power_capacity], ["Durée de Décharge (heures)", inputs.discharge_duration], ["Capacité Énergétique (kWh)", financialResults.E_cap_kWh], [], ["Bilan Annuel"], ["Production PV (kWh)", simResults.totals.production], ["Consommation (kWh)", simResults.totals.consumption], ["Import Réseau (kWh)", simResults.totals.import], ["Export Réseau (kWh)", simResults.totals.export], ["Taux d'autoconsommation (%)", (simResults.totals.direct + simResults.totals.discharge) / simResults.totals.production * 100], ["Taux d'autosuffisance (%)", (simResults.totals.direct + simResults.totals.discharge) / simResults.totals.consumption * 100], [], ["Analyse Financière"], ["Investissement Initial ($)", financialResults.initial_investment], ["Durée de vie (années)", financialResults.N_op], ["Cycles Annuels", financialResults.annual_cycles], ["LCOS ($/kWh)", financialResults.lcos], ["Retour sur Investissement (années)", isFinite(financialResults.simple_payback) ? financialResults.simple_payback : "N/A"] ]; const hourly_ws_data = [ ["Profil Horaire Annuel (Wh)"], ["Heure", "Production", "Consommation", "SOC (%)", "Charge Batterie", "Décharge Batterie", "Import Réseau", "Export Réseau", "Bilan Financier ($)"] ]; const startDate = new Date('2025-01-01T00:00:00'); for (let i = 0; i < simResults.hourly.prod.length; i++) { const timestamp = new Date(startDate.getTime() + i * 60 * 60 * 1000); hourly_ws_data.push([ timestamp.toISOString(), simResults.hourly.prod[i], simResults.hourly.cons[i], simResults.hourly.soc[i], simResults.hourly.batteryCharge[i], simResults.hourly.batteryDischarge[i], simResults.hourly.gridImport[i], simResults.hourly.gridExport[i], simResults.hourly.hourlyNetCost[i] ]); } const wb = XLSX.utils.book_new(); const ws_summary = XLSX.utils.aoa_to_sheet(summary_ws_data); const ws_hourly = XLSX.utils.aoa_to_sheet(hourly_ws_data); XLSX.utils.book_append_sheet(wb, ws_summary, "Rapport Synthétique"); XLSX.utils.book_append_sheet(wb, ws_hourly, "Données Horaires Annuelles"); XLSX.writeFile(wb, "Rapport_Stockage_Energie.xlsx"); }

            // --- EVENT LISTENERS ---
            techSelector.addEventListener('change', (e) => populateTechInputs(e.target.value));
            calculateButton.addEventListener('click', calculateAndShowResults);
            weekSelector.addEventListener('change', updateAndDisplayWeeklyChart);
            downloadButton.addEventListener('click', downloadReport);
            profileUploader.addEventListener('change', handleProfileFile);
            optimizeButton.addEventListener('click', runOptimization);
            compareButton.addEventListener('click', runComparativeAnalysis);
            document.querySelectorAll('.tab-button').forEach(button => { button.addEventListener('click', () => { document.querySelectorAll('.tab-button, .tab-content').forEach(el => el.classList.remove('active')); button.classList.add('active'); document.getElementById(button.dataset.tab).classList.add('active'); }); });

            populateTechInputs(techSelector.value);
            weekSelector.disabled = true;
        });
    </script>
</body>
</html>
